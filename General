from pyspark.sql.functions import col, substring, lit
from datetime import datetime

# Step 1: Extract the start year from Der_Financial_Year
isp_spell_hrg_period_df = isp_spell_hrg_period_df.withColumn(
    "Start_Year", substring("Der_Financial_Year", 1, 4).cast("int")
)

# Step 2: Calculate the current financial year and the cutoff for last 5 years
current_year = datetime.now().year
cutoff_year = current_year - 5

# Step 3: Filter rows for the last 5 financial years
last_5_years_df = isp_spell_hrg_period_df.filter(
    col("Start_Year") >= lit(cutoff_year)
)

# Step 4: Drop the temporary 'Start_Year' column (optional)
last_5_years_df = last_5_years_df.drop("Start_Year")

# Step 5: Show the result
last_5_years_df.show(truncate=False)

